{% extends 'base.html' %}

{% block content %}
  <form id=login action="/login">
    <input type="submit" value="Log in" />
  </form>

  <form id=logout action="/logout">
    <input type="submit" value="Log out" />
  </form>

  <form id=request_token action="/request_token" method=post>
    <input type="submit" value="Request token" />
  </form>
{% endblock %}

{% block script %}
<script>
function getHashParams() {

    var hashParams = {};
    var e,
        a = /\+/g,  // Regex for replacing addition symbol with a space
        r = /([^&;=]+)=?([^&;]*)/g,
        d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
        q = window.location.hash.substring(1);

    while (e = r.exec(q))
       hashParams[d(e[1])] = d(e[2]);

    return hashParams;
}

function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}


let access = getCookie('access');
if (window.location.hash) {
    let textNode = document.createTextNode('user logged in, keycloak returned ' + JSON.stringify(getHashParams()));
    let p = document.createElement("p");
    p.appendChild(textNode);
    document.body.appendChild(p);

    var form = document.getElementById('request_token');
    form.addEventListener('submit', function(){
        var hidden = document.createElement("input");
        hidden.setAttribute('type', 'hidden');
        hidden.setAttribute('name', 'code');
        hidden.setAttribute('value', getHashParams().code);
        this.appendChild(hidden);
    });
    document.getElementById('login').remove()
}

else if (access) {
    let parsed_access = parseJwt(access);
    let username = parsed_access.name;
    let textNode = document.createTextNode('Hello ' + username + '! You can check debug info about your access token in dev console');
    let p = document.createElement("p");
    p.appendChild(textNode);
    document.body.appendChild(p);
    console.debug(parsed_access)
    document.getElementById('login').remove()
    document.getElementById('request_token').remove()
    // добавить refresh?
}
else {
    document.getElementById('request_token').remove()
    document.getElementById('logout').remove()
}

</script>

{% endblock %}
